# RAG База знаний n8n

Эта папка содержит базы знаний (RAG - Retrieval-Augmented Generation) для различных ботов n8n.

## Структура

```
rags/
├── mandala-bot-advanced/    # База знаний для Mandala Bot
│   ├── m1                   # Основная информация о мандалах
│   ├── m2                   # Алгоритм рисования мандалы
│   ├── knowledge.txt        # Объединённый файл (используется workflow)
│   └── README.md           # Документация по этой базе
└── fitbot/                  # База знаний для FitBot
    └── knowledge.txt        # Научная база о питании и похудении
```

## Путь на сервере

Все RAG базы синхронизируются с сервером:

```
Локально:  /Users/pandanax/dev/n8n/rags/
Сервер:    /home/node/.n8n-files/rags/
Контейнер: /home/node/.n8n-files/rags/ (read-only)
```

## Быстрая синхронизация

Для синхронизации всех баз знаний на сервер используйте скрипт:

```bash
./scripts/sync-rags.sh
```

Скрипт автоматически:
- Создаст необходимые директории на сервере
- Синхронизирует все файлы из `rags/`
- Установит правильные права доступа
- Проверит успешность синхронизации

## Добавление новой базы знаний

1. Создайте подпапку: `rags/your-bot-name/`
2. Добавьте файлы с знаниями (например, `knowledge.txt`)
3. Синхронизируйте на сервер:
   ```bash
   ./scripts/sync-rags.sh
   ```
4. В workflow используйте путь: `/home/node/.n8n-files/rags/your-bot-name/knowledge.txt`

### Ручная синхронизация (альтернатива)

Если нужно загрузить только одну базу:

```bash
# Синхронизация конкретной папки
rsync -avz --progress rags/your-bot-name/ ubuntu@84.252.137.46:/tmp/your-bot-name/

# Перемещение в нужное место с правильными правами
ssh ubuntu@84.252.137.46 "sudo mkdir -p /home/node/.n8n-files/rags && \
  sudo mv /tmp/your-bot-name /home/node/.n8n-files/rags/ && \
  sudo chown -R 1000:1000 /home/node/.n8n-files/rags/"
```

## Важно

- Файлы монтируются в контейнер n8n как **read-only** для безопасности
- После изменения файлов локально, нужно загрузить их на сервер
- Перезапуск контейнера не требуется - workflow подхватит изменения при следующем запуске
- Права доступа: 1000:1000 (пользователь node в контейнере)

## Существующие базы

### mandala-bot-advanced
- **Описание**: База знаний о персональных мандалах
- **Содержит**: Типы мандал, нумерологические расчёты, алгоритмы рисования
- **Размер**: ~8KB
- **Workflow**: `workflows/mandala-bot-advanced.json`
- **Путь**: `/home/node/.n8n-files/rags/mandala-bot-advanced/knowledge.txt`

### fitbot
- **Описание**: Научная база знаний о питании и физиологии похудения
- **Содержит**: Энергетический баланс, макронутриенты, режим питания, развенчание мифов
- **Размер**: ~14KB
- **Workflow**: `workflows/telegram-fitbot.json`
- **Путь**: `/home/node/.n8n-files/rags/fitbot/knowledge.txt`

## Обновление баз знаний

При изменении содержимого базы знаний:

1. Отредактируйте файл локально (например, `rags/fitbot/knowledge.txt`)
2. Синхронизируйте изменения:
   ```bash
   ./scripts/sync-rags.sh
   ```
3. Workflow автоматически подхватит изменения при следующем запуске

## Проверка синхронизации

Убедитесь что файлы доступны в контейнере:

```bash
# Подключитесь к серверу
ssh ubuntu@84.252.137.46

# Проверьте содержимое папки
ls -la /home/node/.n8n-files/rags/

# Проверьте из контейнера
docker exec -it n8n ls -la /home/node/.n8n-files/rags/

# Прочитайте файл
docker exec -it n8n cat /home/node/.n8n-files/rags/fitbot/knowledge.txt | head -20
```

## Рекомендации по структуре базы знаний

### Формат файлов
- Используйте plain text (`.txt`) или Markdown (`.md`)
- UTF-8 кодировка обязательна
- Избегайте специальных символов, которые могут сломать JSON

### Организация контента
```markdown
# НАЗВАНИЕ БАЗЫ ЗНАНИЙ

## I. РАЗДЕЛ 1

### 1.1 Подраздел

**Ключевой факт:** описание

**Практический вывод:** рекомендации

---

## II. РАЗДЕЛ 2
...
```

### Оптимизация размера
- Удаляйте дублирующуюся информацию
- Используйте сокращения для часто повторяющихся терминов
- Структурируйте информацию иерархически
- Рекомендуемый размер: 10-50KB (балans между полнотой и скоростью)

## Мониторинг использования

Токены, потребляемые базой знаний, влияют на стоимость API запросов:

```
Размер базы (символы) ÷ 4 ≈ Токены
Например: 14KB ≈ 3500 токенов
```

**DeepSeek V3 стоимость:**
- Input: $0.27 / 1M tokens
- 3500 токенов ≈ $0.00095 за запрос

При большом количестве запросов рассмотрите оптимизацию базы знаний.

## Troubleshooting

### База знаний не загружается

**Симптом:** Бот отвечает "База знаний не загружена"

**Решение:**
1. Проверьте путь в workflow (узел "Read Knowledge Base")
2. Проверьте наличие файла на сервере
3. Проверьте права доступа (должен быть readable для uid 1000)
4. Проверьте, что volume смонтирован в docker-compose.yml

### Ошибка чтения файла

**Симптом:** "Ошибка чтения базы знаний: ..."

**Возможные причины:**
- Неправильная кодировка (используйте UTF-8)
- Битый файл (проверьте целостность)
- Слишком большой файл (рекомендуется < 100KB)

### Бот игнорирует базу знаний

**Симптом:** Бот отвечает, но не использует информацию из базы

**Решение:**
1. Проверьте system prompt в узле "Build AI Context"
2. Убедитесь что база знаний добавляется в промпт
3. Увеличьте `temperature` для более креативных ответов
4. Явно укажите в промпте использовать базу знаний
