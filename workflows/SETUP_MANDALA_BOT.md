# üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Mandala Bot Advanced

–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π AI –±–æ—Ç-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –º–∞–Ω–¥–∞–ª–∞–º —Å –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞ –∏ –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π (RAG)

---

## üåü –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞

- ‚úÖ **–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:** –≠–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –º–∞–Ω–¥–∞–ª
- ‚úÖ **–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:** –ü–æ–º–Ω–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ **RAG (–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π):** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–Ω–∞–Ω–∏—è –æ –º–∞–Ω–¥–∞–ª–∞—Ö –∏–∑ `rags/m1`
- ‚úÖ **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è:** –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–∞–Ω–¥–∞–ª—ã –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è –∏ –∏–º–µ–Ω–∏
- ‚úÖ **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** –î–∞–µ—Ç –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫–∞–∫ —Ä–∏—Å–æ–≤–∞—Ç—å –º–∞–Ω–¥–∞–ª—É
- ‚úÖ **Multi-user:** –û—Ç–¥–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **PostgreSQL** - –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ (—É–∂–µ –µ—Å—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!)
2. **DeepSeek API –∫–ª—é—á** (—É–∂–µ –µ—Å—Ç—å)
3. **Telegram Bot** (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω: MandalaBot)
4. **–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π** - —Ñ–∞–π–ª `rags/m1` (—É–∂–µ –µ—Å—Ç—å)

---

## üóÑÔ∏è –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ PostgreSQL

### 1.1 –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL

```bash
# SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh ubuntu@<server-ip>

# –í–æ–π—Ç–∏ –≤ PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker exec -it n8n-postgres psql -U n8n -d n8n
```

### 1.2 –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏

```sql
CREATE TABLE IF NOT EXISTS chat_history (
    id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    role VARCHAR(20) NOT NULL, -- 'user' –∏–ª–∏ 'assistant'
    content TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    INDEX idx_user_created (user_id, created_at DESC)
);

-- –ü—Ä–æ–≤–µ—Ä–∫–∞
\dt chat_history
SELECT * FROM chat_history LIMIT 1;
```

### 1.3 (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

```sql
-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
CREATE OR REPLACE FUNCTION cleanup_old_messages()
RETURNS void AS $$
BEGIN
    DELETE FROM chat_history 
    WHERE created_at < NOW() - INTERVAL '30 days';
END;
$$ LANGUAGE plpgsql;

-- –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å cron
SELECT cleanup_old_messages();
```

---

## üîë –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Credentials –≤ n8n

### 2.1 PostgreSQL Credentials

1. n8n ‚Üí **Settings** ‚Üí **Credentials** ‚Üí **Add Credential**
2. –í—ã–±–µ—Ä–∏ **"PostgreSQL"**
3. –ó–∞–ø–æ–ª–Ω–∏:

```
Credential Name: PostgreSQL
Host: postgres  (–∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ Docker Compose)
Database: n8n
User: n8n
Password: <POSTGRES_PASSWORD –∏–∑ deploy/.env>
Port: 5432
SSL: Disable (–≤–Ω—É—Ç—Ä–∏ Docker network –Ω–µ –Ω—É–∂–µ–Ω)
```

4. **Test Connection** ‚Üí –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å OK
5. **Save**

### 2.2 DeepSeek API Credentials

1. n8n ‚Üí **Settings** ‚Üí **Credentials** ‚Üí **Add Credential**
2. –í—ã–±–µ—Ä–∏ **"OpenAI"**
3. –ó–∞–ø–æ–ª–Ω–∏:

```
Credential Name: DeepSeek API
API Key: <–¢–í–û–ô_DEEPSEEK_API_KEY>
```

4. **Save**

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** Telegram Bot credentials (MandalaBot) —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!

---

## üìÇ –®–∞–≥ 3: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –±–∞–∑—É –∑–Ω–∞–Ω–∏–π (RAG)

–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —É–∂–µ –µ—Å—Ç—å –≤ `rags/m1`, –Ω–æ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –≤ workflow.

### –í —É–∑–ª–µ "Read Knowledge Base":

1. –û—Ç–∫—Ä–æ–π workflow
2. –ù–∞–π–¥–∏ —É–∑–µ–ª **"Read Knowledge Base"**
3. –í –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —É–∫–∞–∂–∏ –ø—É—Ç—å:

```
File Path: /data/rags/m1
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å:
```
File Path: /Users/pandanax/dev/n8n/rags/m1
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ü—É—Ç—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ n8n –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –í—Å—Ç—Ä–æ–∏—Ç—å –∑–Ω–∞–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é

–ï—Å–ª–∏ –ø—É—Ç—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –º–æ–∂–µ—à—å –≤—Å—Ç—Ä–æ–∏—Ç—å –∑–Ω–∞–Ω–∏—è –≤ System Prompt:
1. –°–∫–æ–ø–∏—Ä—É–π —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `rags/m1`
2. –í—Å—Ç–∞–≤—å –≤ —É–∑–µ–ª "Build AI Context" –≤ —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é

---

## üì• –®–∞–≥ 4: –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å Workflow

1. n8n ‚Üí **Import from File**
2. –í—ã–±–µ—Ä–∏: `mandala-bot-advanced.json`
3. Workflow –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ

---

## üîó –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Å–µ Credentials –≤ Workflow

–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤—Å–µ —É–∑–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ credentials:

### ‚úÖ Telegram Trigger
- Credential: **MandalaBot** ‚úÖ (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

### ‚úÖ Load Chat History
- Credential: **PostgreSQL** (—Å–æ–∑–¥–∞–ª–∏ –≤ —à–∞–≥–µ 2.1)

### ‚úÖ DeepSeek AI
- Credential: **DeepSeek API** (—Å–æ–∑–¥–∞–ª–∏ –≤ —à–∞–≥–µ 2.2)

### ‚úÖ Save to History
- Credential: **PostgreSQL** (—Ç–æ—Ç –∂–µ —á—Ç–æ –≤ Load)

### ‚úÖ Send AI Reply
- Credential: **MandalaBot** ‚úÖ (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

---

## ‚öôÔ∏è –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –í —É–∑–ª–µ "DeepSeek AI":

```javascript
temperature: 0.8       // –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å (0.0-1.5)
maxTokens: 2000        // –ú–∞–∫—Å –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ (–¥–ª—è –º–∞–Ω–¥–∞–ª –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ)
baseURL: https://api.deepseek.com
```

### –í —É–∑–ª–µ "Load Chat History":

```sql
LIMIT 10  -- –ó–∞–≥—Ä—É–∂–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
```

–ú–æ–∂–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 5, 20, 50 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω—É–∂–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

### –í —É–∑–ª–µ "Build AI Context":

System Prompt –º–æ–∂–µ—à—å –¥–æ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –º–∞–Ω–¥–∞–ª
- –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

---

## üöÄ –®–∞–≥ 7: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å Workflow

1. –£–±–µ–¥–∏—Å—å —á—Ç–æ –≤—Å–µ credentials –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã ‚úÖ
2. –£–±–µ–¥–∏—Å—å —á—Ç–æ PostgreSQL —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ ‚úÖ
3. –£–±–µ–¥–∏—Å—å —á—Ç–æ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω–∞ ‚úÖ
4. **Save workflow** (Ctrl+S)
5. –ü–µ—Ä–µ–∫–ª—é—á–∏ **"Inactive" ‚Üí "Active"**

n8n –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç webhook!

---

## üß™ –®–∞–≥ 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü—Ä–∏–≤–µ—Ç!
–ë–æ—Ç: [–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ —Å–µ–±–µ –∫–∞–∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–µ –ø–æ –º–∞–Ω–¥–∞–ª–∞–º]
```

### –¢–µ—Å—Ç 2: –ó–∞–ø—Ä–æ—Å –º–∞–Ω–¥–∞–ª—ã

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –•–æ—á—É —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –º–∞–Ω–¥–∞–ª—É
–ë–æ—Ç: [–°–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–∞–∫–æ–π —Ç–∏–ø –º–∞–Ω–¥–∞–ª—ã, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è]
```

### –¢–µ—Å—Ç 3: –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ú–æ—è –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è 27.11.1991
–ë–æ—Ç: [–ù–∞—á–∏–Ω–∞–µ—Ç —Ä–∞—Å—á–µ—Ç –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –º–∞–Ω–¥–∞–ª—ã, –≤—ã–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏]
```

### –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ê –∫–∞–∫—É—é –¥–∞—Ç—É —è —Ç–µ–±–µ –¥–∞–ª?
–ë–æ—Ç: [–í—Å–ø–æ–º–∏–Ω–∞–µ—Ç –¥–∞—Ç—É 27.11.1991 –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞]
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Workflow

```
[Telegram Trigger] - –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       ‚Üì
[Extract User Data] - –ò–∑–≤–ª–µ–∫–∞–µ—Ç userId, chatId, message, timestamp
       ‚Üì
[Load Chat History] ‚Üê PostgreSQL - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       ‚Üì
[Format History] - –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è AI
       ‚Üì
[Read Knowledge Base] ‚Üí [Load RAG Knowledge] - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –æ –º–∞–Ω–¥–∞–ª–∞—Ö
       ‚Üì
[Build AI Context] - –û–±—ä–µ–¥–∏–Ω—è–µ—Ç: system prompt + –∏—Å—Ç–æ—Ä–∏—è + RAG + —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
       ‚Üì
[DeepSeek AI] - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –º–∞–Ω–¥–∞–ª–∞–º
       ‚Üì
[Save to History] ‚Üí PostgreSQL - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç –≤ –ë–î
       ‚Üì
[Send AI Reply] - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –≤ Telegram —Å Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
```

### –ö–ª—é—á–µ–≤—ã–µ —É–∑–ª—ã:

**1. Load Chat History** (PostgreSQL)
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ORDER BY created_at DESC (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ)
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é (–ø–æ user_id)

**2. Build AI Context** (Code Node)
- –§–æ—Ä–º–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ messages –¥–ª—è DeepSeek
- –î–æ–±–∞–≤–ª—è–µ—Ç system prompt —Å —Ä–æ–ª—å—é —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –º–∞–Ω–¥–∞–ª–∞–º
- –í—Å—Ç–∞–≤–ª—è–µ—Ç –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –∏–∑ RAG
- –î–æ–±–∞–≤–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
- –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

**3. DeepSeek AI**
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- temperature: 0.8 (–±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å—é)

**4. Save to History**
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –û–ë–ê —Å–æ–æ–±—â–µ–Ω–∏—è: –æ—Ç user –∏ –æ—Ç assistant
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–¥–∏–Ω INSERT —Å –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "Table chat_history does not exist"

```
–†–µ—à–µ–Ω–∏–µ:
1. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ PostgreSQL
2. –°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É (—Å–º. –®–∞–≥ 1.2)
3. –ü—Ä–æ–≤–µ—Ä—å: SELECT * FROM chat_history;
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: PostgreSQL Credential –æ—à–∏–±–∫–∞

```
–†–µ—à–µ–Ω–∏–µ:
1. –ü—Ä–æ–≤–µ—Ä—å Host: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "postgres" (–∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
2. –ü—Ä–æ–≤–µ—Ä—å Password –∏–∑ deploy/.env
3. Test Connection –≤ n8n
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

```
–†–µ—à–µ–Ω–∏–µ:
1. –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É rags/m1
2. –ò—Å–ø–æ–ª—å–∑—É–π –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å
3. –ò–ª–∏ –≤—Å—Ç—Ä–æ–π –∑–Ω–∞–Ω–∏—è –ø—Ä—è–º–æ –≤ System Prompt
```

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –ë–æ—Ç –Ω–µ –ø–æ–º–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é

```
–ü—Ä–æ–≤–µ—Ä–∫–∞:
1. –í PostgreSQL: SELECT * FROM chat_history WHERE user_id=<—Ç–≤–æ–π_user_id>;
2. –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏ —Å role='user' –∏ role='assistant'
3. –í n8n Executions —Å–º–æ—Ç—Ä–∏ —É–∑–µ–ª "Load Chat History" - –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
```

### –ü—Ä–æ–±–ª–µ–º–∞ 5: –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–µ –∫–∞–∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç

```
–†–µ—à–µ–Ω–∏–µ:
1. –ü—Ä–æ–≤–µ—Ä—å —É–∑–µ–ª "Build AI Context"
2. –£–±–µ–¥–∏—Å—å —á—Ç–æ system prompt —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø—Ä–æ –º–∞–Ω–¥–∞–ª—ã
3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å (—É–∑–µ–ª "Load RAG Knowledge")
```

---

## üí° –°–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –¢–∏–ø–∏—á–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º:

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü—Ä–∏–≤–µ—Ç! –ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?
–ë–æ—Ç: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –º–∞–Ω–¥–∞–ª...

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –•–æ—á—É –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –º–∞–Ω–¥–∞–ª—É
–ë–æ—Ç: –û—Ç–ª–∏—á–Ω–æ! –î–ª—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –º–∞–Ω–¥–∞–ª—ã –º–Ω–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–∞—à–∞ –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è...

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: 15.03.1985
–ë–æ—Ç: –°–ø–∞—Å–∏–±–æ! –ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—á—ë—Ç –≤–∞—à–µ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –º–∞–Ω–¥–∞–ª—ã...
[–í—ã–¥–∞–µ—Ç —Ä–∞—Å—á–µ—Ç—ã, —Ü–≤–µ—Ç–∞, –∑–Ω–∞—á–µ–Ω–∏—è, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏]

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ê —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –º–æ–π –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Ü–≤–µ—Ç?
–ë–æ—Ç: [–í—Å–ø–æ–º–∏–Ω–∞–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –æ–±—ä—è—Å–Ω—è–µ—Ç]
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏:

```sql
-- –û—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
-- –î–æ–±–∞–≤—å –≤ cron job (–≤—ã–ø–æ–ª–Ω—è—Ç—å —Ä–∞–∑ –≤ –¥–µ–Ω—å):
DELETE FROM chat_history 
WHERE id NOT IN (
    SELECT id FROM (
        SELECT id FROM chat_history 
        WHERE user_id = chat_history.user_id 
        ORDER BY created_at DESC 
        LIMIT 20
    ) subquery
);
```

---

## üé® –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π

### –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã:

–ü–µ—Ä–µ–¥ —É–∑–ª–æ–º "Load Chat History" –¥–æ–±–∞–≤—å —É–∑–µ–ª **"Switch"**:

```
/start  ‚Üí –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞
/help   ‚Üí –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
/reset  ‚Üí –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (DELETE WHERE user_id=X)
/types  ‚Üí –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∏–ø—ã –º–∞–Ω–¥–∞–ª
*       ‚Üí –û–±—ã—á–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å AI
```

### –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –∑–Ω–∞–Ω–∏–π:

1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª—ã: `rags/m2`, `rags/m3` —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
2. –í —É–∑–ª–µ "Read Knowledge Base" –∑–∞–≥—Ä—É–∂–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤
3. –û–±—ä–µ–¥–∏–Ω—è–π –≤ "Build AI Context"

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:

–î–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∞–Ω–¥–∞–ª –º–æ–∂–Ω–æ:
1. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å DALL-E / Midjourney API
2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Python –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
3. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram (—É–∑–µ–ª "Send Photo")

### –≠–∫—Å–ø–æ—Ä—Ç –º–∞–Ω–¥–∞–ª—ã:

–î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞:
1. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF —Å —Ä–∞—Å—á–µ—Ç–∞–º–∏
2. –°–æ–∑–¥–∞–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞–Ω–¥–∞–ª—ã
3. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏:

```sql
-- –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π
SELECT COUNT(*) FROM chat_history;

-- –°–∫–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT COUNT(DISTINCT user_id) FROM chat_history;

-- –¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT user_id, COUNT(*) as messages 
FROM chat_history 
GROUP BY user_id 
ORDER BY messages DESC 
LIMIT 10;

-- –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT role, content, created_at 
FROM chat_history 
WHERE user_id = <USER_ID> 
ORDER BY created_at DESC 
LIMIT 20;
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ PostgreSQL (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –≤ Docker)
- ‚úÖ –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é
- ‚úÖ API –∫–ª—é—á–∏ –≤ credentials (–Ω–µ –≤ –∫–æ–¥–µ)

### –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö:

–ü–æ GDPR –∏–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```sql
-- –£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
DELETE FROM chat_history WHERE user_id = <USER_ID>;
```

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ:

```bash
# –ë–µ–∫–∞–ø —Ç–∞–±–ª–∏—Ü—ã chat_history
docker exec n8n-postgres pg_dump -U n8n -t chat_history n8n > chat_history_backup.sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
cat chat_history_backup.sql | docker exec -i n8n-postgres psql -U n8n -d n8n
```

---

## üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (RAG)

–¢–µ–∫—É—â–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –≤ `rags/m1` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- –ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞–Ω–¥–∞–ª—ã
- –¢–∏–ø—ã –º–∞–Ω–¥–∞–ª
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –º–∞–Ω–¥–∞–ª—ã –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è
- –ù—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞
- –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –º–∞–Ω–¥–∞–ª—ã
- –¶–≤–µ—Ç–∞ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:

1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Ñ–∞–π–ª `rags/m1`
2. –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–π workflow
3. –ê–∫—Ç–∏–≤–∏—Ä—É–π –∑–∞–Ω–æ–≤–æ (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏ - –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏)

---

**–ì–æ—Ç–æ–≤–æ!** –¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è –º–æ—â–Ω—ã–π AI-–±–æ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –º–∞–Ω–¥–∞–ª–∞–º! üé®ü§ñ

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ù–µ –∑–∞–±—É–¥—å —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ PostgreSQL –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º!
