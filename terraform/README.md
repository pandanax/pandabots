# Terraform –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è n8n –ø—Ä–æ–µ–∫—Ç–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
terraform/
‚îú‚îÄ‚îÄ versions.tf           # –í–µ—Ä—Å–∏–∏ Terraform –∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ provider.tf           # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Yandex Cloud –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
‚îú‚îÄ‚îÄ variables.tf          # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚îú‚îÄ‚îÄ network.tf            # VPC, –ø–æ–¥—Å–µ—Ç–∏, External IP
‚îú‚îÄ‚îÄ security.tf           # Security Groups
‚îú‚îÄ‚îÄ compute.tf            # –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞
‚îú‚îÄ‚îÄ oslogin.tf            # üîê OS Login IAM —Ä–æ–ª–∏
‚îú‚îÄ‚îÄ postgresql.tf         # Managed PostgreSQL –∫–ª–∞—Å—Ç–µ—Ä
‚îú‚îÄ‚îÄ dns.tf                # DNS –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
‚îú‚îÄ‚îÄ cloud-init.yaml       # Cloud-init —Å–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ VM
‚îú‚îÄ‚îÄ outputs.tf            # –í—ã—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
‚îú‚îÄ‚îÄ terraform.tfvars.example  # –ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
‚îî‚îÄ‚îÄ README.md             # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## –ß—Ç–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è

1. **VPC Network** - –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Å–µ—Ç—å
2. **Subnet** - –ø–æ–¥—Å–µ—Ç—å –≤ –∑–æ–Ω–µ ru-central1-b
3. **Static External IP** - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–Ω–µ—à–Ω–∏–π IP –∞–¥—Ä–µ—Å
4. **Security Group** - –ø—Ä–∞–≤–∏–ª–∞ firewall
5. **Virtual Machine** - —Å–µ—Ä–≤–µ—Ä Ubuntu 22.04 LTS —Å:
   - Docker –∏ Docker Compose
   - UFW firewall
   - Fail2ban
   - **OS Login** –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ SSH –¥–æ—Å—Ç—É–ø–∞
   - –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –¥–ª—è n8n
6. **OS Login IAM Roles** - —Ä–æ–ª–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ VM —á–µ—Ä–µ–∑ `yc compute ssh`
7. **Managed PostgreSQL** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è n8n

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Terraform

**macOS:**
```bash
brew tap hashicorp/tap
brew install hashicorp/tap/terraform
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
terraform --version
```

### 2. –£–∑–Ω–∞—Ç—å —Å–≤–æ–π –ø—É–±–ª–∏—á–Ω—ã–π IP –∞–¥—Ä–µ—Å

```bash
curl ifconfig.me
```

–ò–ª–∏ –æ—Ç–∫—Ä–æ–π https://ifconfig.me –≤ –±—Ä–∞—É–∑–µ—Ä–µ.

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSH –∫–ª—é—á

```bash
ls -la ~/.ssh/id_rsa.pub
```

–ï—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–π:
```bash
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

```bash
cd terraform/

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
cp terraform.tfvars.example terraform.tfvars

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å terraform.tfvars
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å–≤–æ–π IP –∞–¥—Ä–µ—Å –≤ allowed_ssh_ip!
nano terraform.tfvars
```

### –®–∞–≥ 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Terraform

```bash
terraform init
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞:
- –°–∫–∞—á–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä Yandex Cloud
- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–∞

```bash
terraform plan
```

–ü–æ–∫–∞–∂–µ—Ç, —á—Ç–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Å—É—Ä—Å–æ–≤ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ~5-6)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é VM (cores, memory)
- IP –∞–¥—Ä–µ—Å –¥–ª—è SSH –¥–æ—Å—Ç—É–ø–∞

### –®–∞–≥ 4: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
terraform apply
```

Terraform —Å–ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ. –í–≤–µ–¥–∏ `yes`.

–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–π–º–µ—Ç ~3-5 –º–∏–Ω—É—Ç.

### –®–∞–≥ 5: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è Terraform –≤—ã–≤–µ–¥–µ—Ç:

```
Outputs:

vm_external_ip = "123.45.67.89"
ssh_command = "ssh ubuntu@123.45.67.89"
dns_record = {
  type = "A"
  host = "n8n"
  value = "123.45.67.89"
  ttl = 300
}
```

–°–æ—Ö—Ä–∞–Ω–∏ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è!

## –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å DNS

–í –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è reg.ru –¥–æ–±–∞–≤—å A-–∑–∞–ø–∏—Å—å:

```
–¢–∏–ø: A
–•–æ—Å—Ç: n8n
–ó–Ω–∞—á–µ–Ω–∏–µ: <vm_external_ip –∏–∑ outputs>
TTL: 300
```

### 2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É

**–ß–µ—Ä–µ–∑ OS Login (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**

```bash
# –ü–æ –∏–º–µ–Ω–∏ VM
yc compute ssh --name n8n-server

# –ü–æ ID
yc compute ssh --id <vm_id>
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - –ø—Ä—è–º–æ–π SSH:**

```bash
ssh ubuntu@<vm_external_ip>
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ OS Login –Ω—É–∂–Ω–æ:
1. –ò–º–µ—Ç—å —Ä–æ–ª—å `compute.osLogin` –∏–ª–∏ `compute.osAdminLogin` –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `oslogin.tf`)
2. –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π SSH –∫–ª—é—á –≤ OS Login –ø—Ä–æ—Ñ–∏–ª—å

–°–º. –ø–æ–ª–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é: [docs/guides/OS_LOGIN_GUIDE.md](../docs/guides/OS_LOGIN_GUIDE.md)

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Docker
docker --version
docker compose version

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å firewall
sudo ufw status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
cat /etc/environment
```

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```bash
terraform show
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä outputs

```bash
terraform output
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –Ω—É–∂–Ω—ã–π `.tf` —Ñ–∞–π–ª –∏–ª–∏ `terraform.tfvars`
2. –ó–∞–ø—É—Å—Ç–∏ `terraform plan` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. –ü—Ä–∏–º–µ–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è: `terraform apply`

### –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã!

```bash
terraform destroy
```

## –§–∞–π–ª—ã –¥–ª—è .gitignore

–°–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã **–ù–ï –î–û–õ–ñ–ù–´** –ø–æ–ø–∞—Å—Ç—å –≤ git:

- `*.tfstate`
- `*.tfstate.*`
- `.terraform/`
- `terraform.tfvars` (—Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–≤–æ–π IP –∏ –ø—É—Ç–∏)

–û–Ω–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.gitignore`.

## –°—Ç–æ–∏–º–æ—Å—Ç—å

–ü—Ä–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ 2 vCPU / 4GB RAM / 30GB SSD:
- **~6000-7000 —Ä—É–±/–º–µ—Å**

–¢–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏ Yandex Cloud.

## Troubleshooting

### –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```
Error: Failed to create IAM token
```

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å –∫ `service_account_key_file` –≤ `terraform.tfvars`

### –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è VM

```
Error: Error while requesting API to create instance
```

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å –∫–≤–æ—Ç—ã –≤ Yandex Cloud (Settings ‚Üí Quotas)

### SSH –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ç–≤–æ–π IP —É–∫–∞–∑–∞–Ω –≤ `allowed_ssh_ip`
2. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á: `ssh -i ~/.ssh/id_rsa ubuntu@IP`
3. –ü–æ–¥–æ–∂–¥–∏ 1-2 –º–∏–Ω—É—Ç—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è VM –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è cloud-init

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å DNS
2. ‚úÖ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ SSH
3. üî≤ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å n8n —á–µ—Ä–µ–∑ Docker Compose
4. üî≤ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
5. üî≤ –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π workflow

–°–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ `docs/04-n8n-deployment.md` (—Å–æ–∑–¥–∞–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º)
